(function(f){function m(a){this.code=a.code;this.name=a.name}function r(a,b){var d=b;"/"!=d[0]&&(d=a,d=1<a.length?d+("/"+b):d+b);"/"==d[d.length-1]&&(d=d.substring(0,d.length-1));return d}function p(a){var b=null,d=this;this.size=a.size||0;this.name=a.name||"";this.type=a.type||"";this.__defineGetter__("blob_",function(){return b});this.__defineSetter__("blob_",function(a){b=a;d.size=b.size;d.name=b.name;d.type=b.type})}function s(a){var b=0,d=0;this.__defineGetter__("position",function(){return b});
this.__defineGetter__("length",function(){return d});this.write=function(c){if(!c)throw Error("Expected blob argument to write.");var e=this;a.file_.blob_=c;if(e.onwritestart)e.onwritestart();g.put(a,function(a){if(e.onwriteend)d=b=a.file_.size,e.onwriteend()},this.onerror)}}function u(a){this.readEntries=function(b,d){if(!b)throw Error("Expected successCallback argument.");g.getAllEntries(a.fullPath,b,d)}}function n(){}function i(a){var b=null;this.__defineGetter__("file_",function(){return b});
this.__defineSetter__("file_",function(a){b=a});this.__defineGetter__("isFile",function(){return!0});this.__defineGetter__("isDirectory",function(){return!1});if(a)this.file_=a.file_,this.name=a.name,this.fullPath=a.fullPath,this.filesystem=a.filesystem}function h(a){this.__defineGetter__("isFile",function(){return!1});this.__defineGetter__("isDirectory",function(){return!0});if(a)this.name=a.name,this.fullPath=a.fullPath,this.filesystem=a.filesystem}function v(a){a=a==f.TEMPORARY?"Temporary":"Persistent";
this.name=(location.protocol+location.host).replace(/:/g,"_")+":"+a;this.root=new h;this.root.fullPath="/";this.root.filesystem=this;this.root.name=""}function q(a){switch(a.target.errorCode){case 12:logger.log("Error - Attempt to open database with a lower version than current.");break;default:logger.log("<p>errorCode: "+a.target.errorCode+"</p>")}console.log(a,a.code,a.message)}if(!f.requestFileSystem&&!f.webkitRequestFileSystem){f.indexedDB=f.indexedDB||f.mozIndexedDB||f.msIndexedDB;f.BlobBuilder=
f.BlobBuilder||f.MozBlobBuilder||f.MSBlobBuilder;f.TEMPORARY=0;f.PERSISTENT=1;if(void 0===f.FileError){var k=function(){};k.prototype.prototype=Error.prototype}k.INVALID_MODIFICATION_ERR=9;k.NOT_FOUND_ERR=1;m.prototype=k.prototype;var j=new m({code:k.INVALID_MODIFICATION_ERR,name:"INVALID_MODIFICATION_ERR"}),o=new m({code:1E3,name:"Not implemented"}),t=new m({code:k.NOT_FOUND_ERR,name:"Not found"}),l=null,g={db:null};p.prototype.constructor=p;s.prototype={seek:function(){throw o;},truncate:function(){throw o;
}};n.prototype={name:null,fullPath:null,filesystem:null,copyTo:function(){},getMetadata:function(){},getParent:function(){},moveTo:function(){},remove:function(a,b){if(!a)throw Error("Expected successCallback argument.");g.delete(this.fullPath,function(){a()},b)},toURL:function(){throw o;}};i.prototype=new n;i.prototype.constructor=i;i.prototype.createWriter=function(a){a(new s(this))};i.prototype.file=function(a,b){if(!a)throw Error("Expected successCallback argument.");if(null==this.file_)if(b)b(t);
else throw t;else a(null==this.file_.blob_?this.file_:this.file_.blob_)};h.prototype=new n;h.prototype.constructor=h;h.prototype.createReader=function(){return new u(this)};h.prototype.getDirectory=function(a,b,d,c){a=r(this.fullPath,a);g.get(a,function(e){!0===b.create&&!0===b.exclusive&&e?c&&c(j):!0===b.create&&!e?(e=new h,e.name=a.split("/").pop(),e.fullPath=a,e.filesystem=l,g.put(e,d,c)):!0===b.create&&e?e.isDirectory?d(new h(e)):c&&c(j):(!b.create||!1===b.create)&&!e?c&&c(j):(!b.create||!1===
b.create)&&e&&e.isFile?c&&c(j):d(new h(e))},c)};h.prototype.getFile=function(a,b,d,c){a=r(this.fullPath,a);g.get(a,function(e){!0===b.create&&!0===b.exclusive&&e?c&&c(j):!0===b.create&&!e?(e=new i,e.name=a.split("/").pop(),e.fullPath=a,e.filesystem=l,e.file_=new p({size:0,name:e.name}),g.put(e,d,c)):!0===b.create&&e?e.isFile?d(new i(e)):c&&c(j):(!b.create||!1===b.create)&&!e?c&&c(j):(!b.create||!1===b.create)&&e&&e.isDirectory?c&&c(j):d(new i(e))},c)};h.prototype.removeRecursively=function(a,b){if(!a)throw Error("Expected successCallback argument.");
g.drop(function(){a()},b)};g.open=function(a,b,d){var c=this,a=f.indexedDB.open(a.replace(":","_"));a.onerror=d||q;a.onupgradeneeded=function(a){logger.log("<p>onupgradeneeded: oldVersion:"+a.oldVersion+" newVersion:"+a.newVersion+"</p>");c.db=a.target.result;c.db.onerror=q;c.db.objectStoreNames.contains("entries")||c.db.createObjectStore("entries")};a.onsuccess=function(a){c.db=a.target.result;c.db.onerror=q;b(a)};a.onblocked=function(){console.log("blocked")}};g.close=function(){this.db.close();
this.db=null};g.drop=function(a,b){if(this.db){var d=f.indexedDB.deleteDatabase(this.db.name);d.onsuccess=function(b){a(b)};d.onerror=b;g.close()}};g.get=function(a,b,d){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_ONLY),a=IDBKeyRange.bound(a,a+"0",!1,!0),c=c.objectStore("entries").get(a);c.onsuccess=function(a){b(a.target.result)};c.onerror=d}};g.getAllEntries=function(a,b,d){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_ONLY),e=[],f=null;"/"!=a&&
(f=IDBKeyRange.bound(a+"/",a+"0",!1,!1));c=c.objectStore("entries").openCursor(f);c.onsuccess=function(c){if(c=c.target.result){var d=c.value;e.push(d.isFile?new i(d):new h(d));c.continue()}else e=e.filter(function(b){var c=b.fullPath.split("/").length,d=a.split("/").length;if("/"==a&&c<d+1||"/"!=a&&c==d+1)return b}),b(e)};c.onerror=d}};g.delete=function(a,b,d){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_WRITE),a=IDBKeyRange.bound(a,a+"0",!1,!0),c=c.objectStore("entries").delete(a);
c.onsuccess=function(){b()};c.onerror=d}};g.put=function(a,b,d){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_WRITE).objectStore("entries").put(a,a.fullPath);c.onsuccess=function(){b(a)};c.onerror=d}};f.addEventListener("beforeunload",function(){g.db.close()},!1);f.idb=g;f.requestFileSystem=function(a,b,d,c){a!=f.TEMPORARY&&a!=f.PERSISTENT&&c?c(j):(l=new v(a,b),g.open(l.name,function(){d(l)},c))};f.resolveLocalFileSystemURL=function(a,b,d){d&&d(o)};if(f===window&&f.RUNNING_TESTS)f.Entry=
n,f.FileEntry=i,f.DirectoryEntry=h}})(self);
