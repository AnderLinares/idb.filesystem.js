(function(f){function n(a){this.code=a.code;this.name=a.name}function p(a,d){var b=d;"/"!=d[0]&&(b=a,b="/"!=a?b+("/"+d):b+d);for(var b=b.split("/"),c=0;c<b.length;++c)".."==b[c]&&(b[c-1]="",b[c]="");b=b.filter(function(a){return a}).join("/");"/"!=b[0]&&(b="/"+b);b=b.replace(/\.\//g,"/");b=b.replace(/\/\//g,"/");b=b.replace(/\/\./g,"/");"/"==b[b.length-1]&&"/"!=b&&(b=b.substring(0,b.length-1));return b}function q(a){var d=null,b=this;this.size=a.size||0;this.name=a.name||"";this.type=a.type||"";this.__defineGetter__("blob_",
function(){return d});this.__defineSetter__("blob_",function(a){d=a;b.size=d.size;b.name=d.name;b.type=d.type})}function t(a){var d=0,b=0;this.__defineGetter__("position",function(){return d});this.__defineGetter__("length",function(){return b});this.write=function(c){if(!c)throw Error("Expected blob argument to write.");a.file_.blob_=c;if(this.onwritestart)this.onwritestart();var e=this;g.put(a,function(a){if(e.onwriteend)b=d=a.file_.size,e.onwriteend()},this.onerror)}}function v(a){var d=!1;this.readEntries=
function(b,c){if(!b)throw Error("Expected successCallback argument.");d?b([]):g.getAllEntries(a.fullPath,function(a){d=!0;b(a)},c)}}function o(){}function i(a){var d=null;this.__defineGetter__("file_",function(){return d});this.__defineSetter__("file_",function(a){d=a});this.__defineGetter__("isFile",function(){return!0});this.__defineGetter__("isDirectory",function(){return!1});if(a)this.file_=a.file_,this.name=a.name,this.fullPath=a.fullPath,this.filesystem=a.filesystem}function h(a){this.__defineGetter__("isFile",
function(){return!1});this.__defineGetter__("isDirectory",function(){return!0});if(a)this.name=a.name,this.fullPath=a.fullPath,this.filesystem=a.filesystem}function w(a){r=a==f.TEMPORARY?"Temporary":"Persistent";this.name=(location.protocol+location.host).replace(/:/g,"_")+":"+r;this.root=new h;this.root.fullPath="/";this.root.filesystem=this;this.root.name=""}function s(a){switch(a.target.errorCode){case 12:console.log("Error - Attempt to open database with a lower version than current.");break;
default:console.log("<p>errorCode: "+a.target.errorCode+"</p>")}console.log(a,a.code,a.message)}if(!f.requestFileSystem&&!f.webkitRequestFileSystem){f.indexedDB=f.indexedDB||f.mozIndexedDB||f.msIndexedDB;f.BlobBuilder=f.BlobBuilder||f.MozBlobBuilder||f.MSBlobBuilder;f.TEMPORARY=0;f.PERSISTENT=1;if(void 0===f.FileError){var l=function(){};l.prototype.prototype=Error.prototype}l.INVALID_MODIFICATION_ERR=9;l.NOT_FOUND_ERR=1;n.prototype=l.prototype;n.prototype.toString=Error.prototype.toString;var j=
new n({code:l.INVALID_MODIFICATION_ERR,name:"INVALID_MODIFICATION_ERR"}),k=new n({code:1E3,name:"Not implemented"}),u=new n({code:l.NOT_FOUND_ERR,name:"Not found"}),m=null,r="temporary",g={db:null};q.prototype.constructor=q;t.prototype={seek:function(){throw k;},truncate:function(){this.onwriteend();throw k;}};o.prototype={name:null,fullPath:null,filesystem:null,copyTo:function(){throw k;},getMetadata:function(){throw k;},getParent:function(){throw k;},moveTo:function(){throw k;},remove:function(a,
d){if(!a)throw Error("Expected successCallback argument.");g.delete(this.fullPath,function(){a()},d)},toURL:function(){return"filesystem:"+(location.protocol+"//"+location.host)+"/"+r.toLowerCase()+this.fullPath}};i.prototype=new o;i.prototype.constructor=i;i.prototype.createWriter=function(a){a(new t(this))};i.prototype.file=function(a,d){if(!a)throw Error("Expected successCallback argument.");if(null==this.file_)if(d)d(u);else throw u;else a(null==this.file_.blob_?this.file_:this.file_.blob_)};
h.prototype=new o;h.prototype.constructor=h;h.prototype.createReader=function(){return new v(this)};h.prototype.getDirectory=function(a,d,b,c){a=p(this.fullPath,a);g.get(a,function(e){!0===d.create&&!0===d.exclusive&&e?c&&c(j):!0===d.create&&!e?(e=new h,e.name=a.split("/").pop(),e.fullPath=a,e.filesystem=m,g.put(e,b,c)):!0===d.create&&e?e.isDirectory?b(new h(e)):c&&c(j):(!d.create||!1===d.create)&&!e?"/"==a?(e=new h,e.name="",e.fullPath="/",e.filesystem=m,b(e)):c&&c(j):(!d.create||!1===d.create)&&
e&&e.isFile?c&&c(j):b(new h(e))},c)};h.prototype.getFile=function(a,d,b,c){a=p(this.fullPath,a);g.get(a,function(e){!0===d.create&&!0===d.exclusive&&e?c&&c(j):!0===d.create&&!e?(e=new i,e.name=a.split("/").pop(),e.fullPath=a,e.filesystem=m,e.file_=new q({size:0,name:e.name}),g.put(e,b,c)):!0===d.create&&e?e.isFile?b(new i(e)):c&&c(j):(!d.create||!1===d.create)&&!e?c&&c(j):(!d.create||!1===d.create)&&e&&e.isDirectory?c&&c(j):b(new i(e))},c)};h.prototype.removeRecursively=function(a,d){if(!a)throw Error("Expected successCallback argument.");
this.remove(a,d)};g.open=function(a,d,b){var c=this,a=f.indexedDB.open(a.replace(":","_"));a.onerror=b||s;a.onupgradeneeded=function(a){console.log("onupgradeneeded: oldVersion:"+a.oldVersion,"newVersion:"+a.newVersion);c.db=a.target.result;c.db.onerror=s;c.db.objectStoreNames.contains("entries")||c.db.createObjectStore("entries")};a.onsuccess=function(a){c.db=a.target.result;c.db.onerror=s;d(a)};a.onblocked=function(){console.log("blocked")}};g.close=function(){this.db.close();this.db=null};g.drop=
function(a,d){if(this.db){var b=f.indexedDB.deleteDatabase(this.db.name);b.onsuccess=function(b){a(b)};b.onerror=d;g.close()}};g.get=function(a,d,b){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_ONLY),a=IDBKeyRange.bound(a,a+"0",!1,!0),c=c.objectStore("entries").get(a);c.onsuccess=function(a){d(a.target.result)};c.onerror=b}};g.getAllEntries=function(a,d,b){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_ONLY),e=[],f=null;"/"!=a&&(f=IDBKeyRange.bound(a+
"/",a+"0",!1,!1));c=c.objectStore("entries").openCursor(f);c.onsuccess=function(b){if(b=b.target.result){var c=b.value;e.push(c.isFile?new i(c):new h(c));b.continue()}else e=e.filter(function(b){var c=b.fullPath.split("/").length,d=a.split("/").length;if("/"==a&&c<d+1||"/"!=a&&c==d+1)return b}),d(e)};c.onerror=b}};g.delete=function(a,d,b){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_WRITE),a=IDBKeyRange.bound(a,a+"0",!1,!0),c=c.objectStore("entries").delete(a);c.onsuccess=
function(){d()};c.onerror=b}};g.put=function(a,d,b){if(this.db){var c=this.db.transaction(["entries"],IDBTransaction.READ_WRITE).objectStore("entries").put(a,a.fullPath);c.onsuccess=function(){d(a)};c.onerror=b}};f.addEventListener("beforeunload",function(){g.db.close()},!1);f.idb=g;f.requestFileSystem=function(a,d,b,c){a!=f.TEMPORARY&&a!=f.PERSISTENT&&c?c(j):(m=new w(a,d),g.open(m.name,function(){b(m)},c))};f.resolveLocalFileSystemURL=function(a,d,b){b&&b(k)};if(f===window&&f.RUNNING_TESTS)f.Entry=
o,f.FileEntry=i,f.DirectoryEntry=h,f.resolveToFullPath_=p}})(self);
