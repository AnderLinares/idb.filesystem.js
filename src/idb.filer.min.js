(function(f){function l(a){this.code=a.code;this.name=a.name}function r(a){"/"!=a[0]&&(a="/"+a);"/"==a[a.length-1]&&(a=a.substring(0,a.length-1));return a}function p(a){var b=null,c=this;this.size=a.size||0;this.name=a.name||"";this.type=a.type||"";this.__defineGetter__("blob_",function(){return b});this.__defineSetter__("blob_",function(a){b=a;c.size=b.size;c.name=b.name;c.type=b.type})}function s(a){var b=0,c=0;this.__defineGetter__("position",function(){return b});this.__defineGetter__("length",
function(){return c});this.write=function(e){if(!e)throw Error("Expected blob argument to write.");var d=this;a.file_.blob_=e;if(d.onwritestart)d.onwritestart();g.put(a,function(a){if(d.onwriteend)c=b=a.file_.size,d.onwriteend()},this.onerror)}}function t(){}function m(){}function i(a){var b=null;this.__defineGetter__("file_",function(){return b});this.__defineSetter__("file_",function(a){b=a});this.__defineGetter__("isFile",function(){return!0});this.__defineGetter__("isDirectory",function(){return!1});
if(a)this.file_=a.file_,this.name=a.name,this.fullPath=a.fullPath,this.filesystem=a.filesystem}function h(a){this.__defineGetter__("isFile",function(){return!1});this.__defineGetter__("isDirectory",function(){return!0});if(a)this.name=a.name,this.fullPath=a.fullPath,this.filesystem=a.filesystem}function v(a){a=a==f.TEMPORARY?"Temporary":"Persistent";this.name=(location.protocol+location.host).replace(/:/g,"_")+":"+a;this.root=new h;this.root.fullPath="/";this.root.filesystem=this;this.root.name=""}
function n(a){switch(a.target.errorCode){case 12:logger.log("Error - Attempt to open database with a lower version than current.");break;default:logger.log("<p>errorCode: "+a.target.errorCode+"</p>")}console.log(a,a.code,a.message)}if(!f.requestFileSystem&&!f.webkitRequestFileSystem){f.indexedDB=f.indexedDB||f.mozIndexedDB||f.msIndexedDB;f.BlobBuilder=f.BlobBuilder||f.MozBlobBuilder||f.MSBlobBuilder;f.TEMPORARY=0;f.PERSISTENT=1;if(void 0===f.FileError){var j=function(){};j.prototype.prototype=Error.prototype}j.INVALID_MODIFICATION_ERR=
9;j.NOT_FOUND_ERR=1;l.prototype=j.prototype;var q=new l({code:j.INVALID_MODIFICATION_ERR,name:"INVALID_MODIFICATION_ERR"}),o=new l({code:1E3,name:"Not implemented"}),u=new l({code:j.NOT_FOUND_ERR,name:"Not found"}),k=null,g={db:null};p.prototype.constructor=p;s.prototype={seek:function(){throw o;},truncate:function(){throw o;}};t.prototype={readEntries:function(a,b){if(!a)throw Error("Expected successCallback argument.");g.getAllEntries(a,b)}};m.prototype={name:null,fullPath:null,filesystem:null,
copyTo:function(){},getMetadata:function(){},getParent:function(){},moveTo:function(){},remove:function(a,b){if(!a)throw Error("Expected successCallback argument.");g.delete(this.fullPath,function(){a()},b)},toURL:function(){throw o;}};i.prototype=new m;i.prototype.constructor=i;i.prototype.createWriter=function(a){a(new s(this))};i.prototype.file=function(a,b){if(!a)throw Error("Expected successCallback argument.");if(null==this.file_)if(b)b(u);else throw u;else a(null==this.file_.blob_?this.file_:
this.file_.blob_)};h.prototype=new m;h.prototype.constructor=h;h.prototype.createReader=function(){return new t};h.prototype.getDirectory=function(a,b,c,e){g.get(a,function(d){if(!(!0===b.create&&!0===b.exclusive&&d))!0===b.create&&!d?(a=r(a),d=new h,d.name=a.split("/").pop(),d.fullPath=a,d.filesystem=k,g.put(d,c,e)):!0===b.create&&d?c(new h(d)):!1===b.create&&!d?e&&e(q):!1===b.create&&d&&d.isFile||c(new h(d))},e)};h.prototype.getFile=function(a,b,c,e){g.get(a,function(d){if(!(!0===b.create&&!0===
b.exclusive&&d))!0===b.create&&!d?(a=r(a),d=new i,d.name=a.split("/").pop(),d.fullPath=a,d.filesystem=k,d.file_=new p({size:0,name:d.name}),g.put(d,c,e)):!0===b.create&&d?c(new i(d)):!1===b.create&&!d?e&&e(q):!1===b.create&&d&&d.isDirectory||c(new i(d))},e)};h.prototype.removeRecursively=function(a,b){if(!a)throw Error("Expected successCallback argument.");g.drop(function(){a()},b)};g.open=function(a,b,c){var e=this,a=f.indexedDB.open(a.replace(":","_"));a.onerror=c||n;a.onupgradeneeded=function(a){logger.log("<p>onupgradeneeded: oldVersion:"+
a.oldVersion+" newVersion:"+a.newVersion+"</p>");e.db=a.target.result;e.db.onerror=n;e.db.objectStoreNames.contains("entries")||e.db.createObjectStore("entries")};a.onsuccess=function(a){e.db=a.target.result;e.db.onerror=n;b(a)};a.onblocked=function(){console.log("blocked")}};g.close=function(){this.db.close();this.db=null};g.addNewObjectStore=function(a){var b=this.db.version;this.close();var c=this,b=f.indexedDB.open(k.name.replace(":","_"),++b);b.onsuccess=function(a){console.log(a.target.result)};
b.onupgradeneeded=function(b){console.log(b.target.result);c.db=b.target.result;c.db.onerror=n;c.db.objectStoreNames.contains(a)||c.db.createObjectStore(a)}};g.drop=function(a,b){if(this.db){var c=f.indexedDB.deleteDatabase(this.db.name);c.onsuccess=function(b){a(b)};c.onerror=b;g.close()}};g.get=function(a,b,c){if(this.db)a=this.db.transaction(["entries"],IDBTransaction.READ_ONLY).objectStore("entries").get(a),a.onsuccess=function(a){b(a.target.result)},a.onerror=c};g.delete=function(a,b,c){if(this.db)a=
this.db.transaction(["entries"],IDBTransaction.READ_WRITE).objectStore("entries").delete(a),a.onsuccess=function(){b()},a.onerror=c};g.put=function(a,b,c){if(this.db){var e=this.db.transaction(["entries"],IDBTransaction.READ_WRITE).objectStore("entries").put(a,a.fullPath);e.onsuccess=function(){b(a)};e.onerror=c}};g.getAllEntries=function(a,b){if(this.db){var c=[],e=this.db.transaction(["entries"],IDBTransaction.READ_ONLY).objectStore("entries").openCursor();e.onsuccess=function(b){if(b=b.target.result){var e=
b.value;c.push(e.isFile?new i(e):new h(e));b.continue()}else a(c)};e.onerror=b}};f.addEventListener("beforeunload",function(){g.db.close()},!1);f.idb=g;f.requestFileSystem=function(a,b,c,e){a!=f.TEMPORARY&&a!=f.PERSISTENT&&e?e(q):(k=new v(a,b),g.open(k.name,function(){c(k)},e))};f.resolveLocalFileSystemURL=function(a,b,c){c&&c(o)};if(f===window&&f.RUNNING_TESTS)f.Entry=m,f.FileEntry=i,f.DirectoryEntry=h}})(self);
